@page "/operations-dailystaffreq"
@using AppModels.DailyReq
@rendermode InteractiveServer
@inject IJSRuntime JsRuntime
@inject IUnitOfWork _unitOfWork
@inject IDialogService _dialogService
@inject ISnackbar _snackbar
@inject ICurrentUserService _currentUser

<PageBreadcrumb Subtitle="Operations" Title="Daily Staff Requisition" />

<MudTable ServerData="ServerReload" Dense="true" Hover="true" Striped="true" @ref="table" FixedHeader="true" FixedFooter="true" Height="450px" RowsPerPage="50" @bind-SelectedItem="_selectedReq">
    <ToolBarContent>
        <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Medium" Href="/operations-dailystaffreqdetails"> Add New </MudButton>
        <MudSpacer />
        <MudTextField T="string" ValueChanged="@(s => OnSearch(s))" Immediate="false" Placeholder="Search" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortLabel="autono" T="VwDailyReq">AutoNo</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="ReqNo" T="VwDailyReq">ReqNo</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="Date" T="VwDailyReq">Date</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="DlecodeCompanyName" T="VwDailyReq">DlecodeCompanyName</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="VesselName" T="VwDailyReq">VesselName</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="ReportingPoint" T="VwDailyReq">ReportingPoint</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="gphaRequestId" T="VwDailyReq">GphaRequestId</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="approved" T="VwDailyReq">Approved</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="submitted" T="VwDailyReq">Submitted</MudTableSortLabel></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="AutoNo">@context.AutoNo</MudTd>
        <MudTd DataLabel="ReqNo">@context.ReqNo</MudTd>
        <MudTd DataLabel="Date">@context.Date.ToString("dd-MMM-yyyy")</MudTd>
        <MudTd DataLabel="DlecodeCompanyName">@context.DlecodeCompanyName</MudTd>
        <MudTd DataLabel="VesselName">@context.VesselName</MudTd>
        <MudTd DataLabel="ReportingPoint">@context.ReportingPoint</MudTd>
        <MudTd DataLabel="GphaRequestId">@context.GphaRequestId</MudTd>
        <MudTd DataLabel="Approved"> <MudCheckBox T="bool" Value="@context.Approved" Disabled="true" Color="Color.Success" /> </MudTd>
        <MudTd DataLabel="Submitted"> <MudCheckBox T="bool?" Value="@context.Submitted" Disabled="true" Color="Color.Success" /> </MudTd>
        <MudTd DataLabel="" Class="d-flex justify-content-center gap-1">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Dark" aria-label="edit" Size="Size.Small" Href="@($"/operations-dailystaffreqdetails/{context.ReqNo}")"></MudIconButton>
            <MudDivider Vertical="true" FlexItem="true" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" aria-label="delete" Size="Size.Small" OnClick="(() => ConfirmRecordDelete(context.ReqNo))"></MudIconButton>
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>No matching records found</MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private MudTable<VwDailyReq> table;
    private VwDailyReq _selectedReq;
    private string searchString = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await JsRuntime.InvokeVoidAsync("loadConfig");
        await JsRuntime.InvokeVoidAsync("loadApps");
    }

    private async Task<TableData<VwDailyReq>> ServerReload(TableState state, CancellationToken token)
    {
        try
        {
            var data = await _unitOfWork.DailyReq.ViewDailyReq(searchString);
            var totalItems = data.Count();

            data = state.SortLabel switch
            {
                "ReqNo" => data.OrderByDirection(state.SortDirection, o => o.ReqNo),
                "Date" => data.OrderByDirection(state.SortDirection, o => o.Date),
                "DlecodeCompanyName" => data.OrderByDirection(state.SortDirection, o => o.DlecodeCompanyName),
                "VesselName" => data.OrderByDirection(state.SortDirection, o => o.VesselName),
                "ReportingPoint" => data.OrderByDirection(state.SortDirection, o => o.ReportingPoint),
                _ => data
            };

            var items = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();

            return new TableData<VwDailyReq>{ TotalItems = totalItems,  Items = items };
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("ShowSwal", "error", ex.Message);
            return new TableData<VwDailyReq> { TotalItems = 0, Items = Array.Empty<VwDailyReq>() };
        }
    }

    private async Task OnSearch(string text)
    {
        searchString = text;
        await table.ReloadServerData();
    }
    private async Task ConfirmRecordDelete(string ReqNo)
    {
        _selectedReq.ReqNo = ReqNo;
        var parameters = new DialogParameters<DeleteConfirm> { { x => x.ContentText, "Are you sure you want to delete?" } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true, BackdropClick = false };
        var dialog = _dialogService.Show<Shared.DeleteConfirm>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await DeleteRecord_Click(true);
        }
        else
        {
            _selectedReq.ReqNo = string.Empty;
        }
    }
    public async Task DeleteRecord_Click(bool isConfirmed)
    {
        if (isConfirmed && !string.IsNullOrEmpty(_selectedReq.ReqNo))
        {
            try
            {
                var userId = await _currentUser.GetUserIdAsync();
                var request = new DeleteReqRequest { ReqNo = _selectedReq.ReqNo, DeleteBy = userId };
                var response = await _unitOfWork.DailyReq.DeleteDailyReq(request);
                if (response == 1)
                {
                    _snackbar.Add("Cost Sheet Deleted Successfully!", Severity.Success);
                    await table.ReloadServerData();
                    _selectedReq.ReqNo = string.Empty;
                }
            }
            catch (Exception ex)
            {
                _snackbar.Add($"Error deleting cost sheet: {ex.Message}", Severity.Error);
                _selectedReq.ReqNo = string.Empty;
            }
        }
    }
}