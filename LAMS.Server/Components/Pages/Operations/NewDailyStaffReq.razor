@page "/operations-dailystaffreqdetails"
@page "/operations-dailystaffreqdetails/{RequestNo}"
@using AppModels.DailyReq
@rendermode InteractiveServer
@inject IJSRuntime JsRuntime
@inject IUnitOfWork _unitOfWork
@inject ISnackbar _snackbar
@inject IDialogService _dialogService

<PageBreadcrumb Subtitle="Operations" Title="@($"{(IsEdit ? "Edit" : "New")} Daily Requisition Details")" />

<DailyReqDetails Model="@Model"></DailyReqDetails>

<SubStaffReqGrid ReqNo="@Model.RequestNo" _readOnly="@(Model.AutoNo == 0 ? true : Model.Approved)" />

<MudPaper Class="pa-3 d-flex flex-wrap gap-2 justify-end">

    <!-- Hidden Buttons -->
    <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small" Style="display:none;">  Find Request </MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" Disabled="true"  Style="display:none;"> Generate Cost Sheet </MudButton>

    <MudCheckBox T="bool" Label="Approved" @bind-Value="Model.Approved" Disabled="true"  Class="ml-4"  Style="color:red;font-size:medium" />
    <MudText Class="mx-2" Style="color:green"> Approval Date </MudText>
    <MudDatePicker @bind-Date="Model.ApprovedDate" ReadOnly="true" Disabled="true" DateFormat="yyyy-MM-dd" Dense="true" Style="max-width:150px;" />
    @if (!IsEdit)
    {
        <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small" OnClick="ResetState"> Add </MudButton>
    }
    @if (IsEdit)
    {
        <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small" OnClick="FindReqNo"> Find </MudButton>
    }
    <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small" Href="/operations-dailystaffreq"> Return </MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Info" Size="Size.Small" Disabled="@(Model.AutoNo == 0 ? true : false)"
    Href="@($"http://172.29.255.101/Reports/Daily/General/vwDailyCostSheet.aspx?reqno={Model.RequestNo}&st={Model.RequisitionDate:yyyy-MM-dd}&ed={Model.RequisitionDate:yyyy-MM-dd}")"
    Target="_blank"> Print </MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" Disabled="@(Model.AutoNo == 0 ? false : true)" OnClick="AddDailyReq"> @(IsEdit ? "Save Changes" : "Save")</MudButton>

</MudPaper>

@code {
    [Parameter]
    public string? RequestNo { get; set; }
    private RequisitionModel Model = new();
    private bool IsEdit => !string.IsNullOrEmpty(RequestNo);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("loadConfig");
            await JsRuntime.InvokeVoidAsync("loadApps");
        }
    }
    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }
    private async Task LoadDataAsync()
    {
        try
        {
            if (IsEdit)
            {
                // EDIT MODE
                var dailyReq = await _unitOfWork.DailyReq.GetDailyReq(RequestNo);
                if (dailyReq == null)
                {
                    _snackbar.Add("This requisition number was not found", Severity.Error);
                    return;
                }
                Model = new RequisitionModel
                {
                    AutoNo = dailyReq.AutoNo,
                    RequestNo = dailyReq.ReqNo,
                    Approved = dailyReq.Approved,
                    ApprovedDate = dailyReq.Adate,
                    RequisitionDate = dailyReq.Date,
                    CompanyId = dailyReq.DlecodeCompanyId,
                    VesselId = dailyReq.VesselberthId!.Value,
                    ReportingPointId = dailyReq.ReportpointId!.Value,
                    LocationId = dailyReq.LocationId!.Value,
                    CargoId = dailyReq.CargoId!.Value,
                    GangId = dailyReq.GangId!.Value,
                    JobDescription = dailyReq.Job,
                    GphaRequestId = dailyReq.GphaRequestId,
                    ShipSide = dailyReq.OnBoardAllowance!.Value,
                    Weekend = dailyReq.Weekends,
                    Night = dailyReq.Night,
                    ShiftType = dailyReq.ShiftType,
                    NormalHours = dailyReq.Normal,
                    OvertimeHours = dailyReq.Overtime,
                };
                if (Model.Approved)
                {
                    _snackbar.Add("This requisition has been approved", Severity.Warning);
                }
            }
            else
            {
                await ResetState();
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("ShowSwal", "error", ex.Message);
            return;
        }
    }
    private async Task ResetState()
    {
        // Reset your state variables here
        // NEW MODE
        var userKey = "DW"; // get from auth/cookie properly
        var newReqNo = await _unitOfWork.DailyReq.GetNewReqNo(userKey);

        Model = new RequisitionModel
        {
            RequestNo = newReqNo,
            RequisitionDate = DateTime.UtcNow,
            Approved = false,
            ApprovedDate = new DateTime(2000,01,01),
            ShiftType = "Non-Shift"
        };
    }
    private async Task AddDailyReq()
    {
        if (Model.CompanyId == 0)
        {
            _snackbar.Add("DLE Company is required", Severity.Warning);
            return;
        }
        if (Model.VesselId == 0)
        {
            _snackbar.Add("Vessel is required", Severity.Warning);
            return;
        }
        if (Model.GangId == 0)
        {
            _snackbar.Add("Gang is required", Severity.Warning);
            return;
        }

        try
        {
            if (IsEdit)
            {
                var response = await _unitOfWork.DailyReq.UpdateDailyReq(Model);
                if (response == 0)
                    _snackbar.Add("Changes Saved Successfully", Severity.Success);
            }
            else
            {
                var result = await _unitOfWork.DailyReq.AddDailyReq(Model);
                
                int returnValue = result.ReturnValue;
                if (returnValue == 0)
                {
                    _snackbar.Add("Saved successfully", Severity.Success);
                    Model.AutoNo = result.AutoNo;
                }
            }
        }
        catch (Exception ex)
        {
            _snackbar.Add($"Error saving record: {ex.Message}", Severity.Error);
        }
    }
    private async Task FindReqNo()
    {
        var parameters = new DialogParameters<FindCostSheetDialog> { };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = _dialogService.Show<FindCostSheetDialog>("Find Cost Sheet", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            RequestNo = result.Data.ToString();
            await LoadDataAsync(); 
        }
    }
}
